{% extends 'admin/base.html' %} {% block content %}
<div class="jumbotron">
    <div class="container">
        <h1>Docker Status</h1>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            {% for error in errors %}
            <div class="alert alert-danger alert-dismissable" role="alert">
                <span class="sr-only">Error:</span>
                {{ error }}
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                    aria-label="Close"
                ></button>
            </div>
            {% endfor %} {% if dockers %}
            <table id="dockers" class="table table-striped">
                <thead>
                    <tr>
                        <th
                            width="10px"
                            class="text-center"
                            style="cursor: pointer"
                            data-column="0"
                        >
                            ID
                        </th>
                        <th class="text-left" style="cursor: pointer" data-column="1">
                            {% if dockers[0].team_id %}Team{% else %}User{% endif %}
                        </th>
                        <th class="text-left" style="cursor: pointer" data-column="2">
                            Docker Image
                        </th>
                        <th class="text-left" style="cursor: pointer" data-column="3">
                            Instance ID
                        </th>
                        <th class="text-left">Revoke</th>
                    </tr>
                </thead>
                <tbody>
                    {% for docker in dockers %}
                    <tr id="tr_{{docker.instance_id}}" name="{{docker.id}}">
                        <td class="text-center" value="{{docker.id}}">{{docker.id}}</td>
                        {% if docker.team_id %}
                        <td class="text-center" value="{{docker.team_id}}">{{docker.team_id}}</td>
                        {% else %}
                        <td class="text-center" value="{{docker.team_id}}">{{docker.user_id}}</td>
                        {% endif %}
                        <td class="text-center" value="{{docker.docker_image}}">
                            {{docker.docker_image}}
                        </td>
                        <td class="text-center" value="{{docker.instance_id | truncate(15)}}">
                            {{docker.instance_id | truncate(15)}}
                        </td>
                        <td class="text-center">
                            <a
                                id="delete_{{docker.instance_id}}"
                                style="cursor: pointer"
                                class="fas fa-trash delete-container-btn"
                                data-instance-id="{{docker.instance_id}}"
                            ></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="text-center">
                <button type="button" class="btn btn-danger" id="nuke-all-btn">
                    Nuke All Containers
                </button>
            </div>
            {% else %}
            <h3 class="text-center">No Docker Containers Active</h3>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Templates (vanilla JS - no Alpine.js dependency) -->
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle"></h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalBody"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-danger" id="confirmModalYes">Yes</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalTitle"></h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <p id="alertModalBody"></p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-dismiss="modal"
                    id="alertModalButton"
                ></button>
            </div>
        </div>
    </div>
</div>

{% endblock content %} {% block scripts %}
<script>
    // Attach event listeners to table headers for sorting
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('#dockers thead th[data-column]').forEach((th) => {
            th.addEventListener('click', function () {
                const columnIndex = parseInt(this.getAttribute('data-column'));
                sortTable(columnIndex);
            });
        });

        // Attach event listeners to delete buttons
        document.querySelectorAll('.delete-container-btn').forEach((btn) => {
            btn.addEventListener('click', function () {
                const instanceId = this.getAttribute('data-instance-id');
                check_nuke_container(instanceId, false);
            });
        });

        // Attach event listener to nuke all button
        const nukeAllBtn = document.getElementById('nuke-all-btn');
        if (nukeAllBtn) {
            nukeAllBtn.addEventListener('click', function () {
                check_nuke_container(null, true);
            });
        }
    });

    function sortTable(n) {
        var table,
            rows,
            switching,
            i,
            x,
            y,
            shouldSwitch,
            dir,
            switchcount = 0;
        table = document.getElementById('dockers');
        switching = true;
        dir = 'asc';
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < rows.length - 1; i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName('TD')[n];
                y = rows[i + 1].getElementsByTagName('TD')[n];
                if (dir == 'asc') {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == 'desc') {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == 'asc') {
                    dir = 'desc';
                    switching = true;
                }
            }
        }
    }
</script>
<script>
    function check_nuke_container(instance, all) {
        ezq({
            title: 'Attention!',
            body: 'Are You Sure You want to do this?',
            success: function () {
                nuke_container(instance, all);
            },
        });
    }

    function nuke_container(instance, all) {
        fetch('/api/v1/nuke', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'CSRF-Token': init.csrfNonce,
            },
            body: JSON.stringify({
                container: instance,
                all: all,
            }),
        })
            .then((response) => {
                if (response.ok) {
                    if (all == true) {
                        window.location = '{{ script_root }}/admin/docker_status';
                    } else {
                        document.getElementById('tr_' + instance).style.display = 'none';
                    }
                } else {
                    throw new Error('Failed to delete container');
                }
            })
            .catch((error) => {
                ezal({
                    title: 'Attention!',
                    body: 'Error when Deleting Docker Container',
                    button: 'Got it!',
                });
            });
    }
</script>
<script>
    // Vanilla JS modal helpers (framework-agnostic, works with BS4/BS5 CSS)
    function showModal(modalEl) {
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        modalEl.setAttribute('aria-modal', 'true');
        modalEl.removeAttribute('aria-hidden');
        var backdrop = document.querySelector('.modal-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
        document.body.classList.add('modal-open');
    }

    function hideModal(modalEl) {
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.removeAttribute('aria-modal');
        modalEl.setAttribute('aria-hidden', 'true');
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
        document.body.classList.remove('modal-open');
    }

    function bindDismissButtons(modalEl) {
        modalEl
            .querySelectorAll('[data-bs-dismiss="modal"], [data-dismiss="modal"]')
            .forEach(function (btn) {
                btn.addEventListener('click', function () {
                    hideModal(modalEl);
                });
            });
    }

    // Confirmation modal function (vanilla JS)
    function ezq(args) {
        var modalEl = document.getElementById('confirmModal');
        document.getElementById('confirmModalTitle').textContent = args.title;
        document.getElementById('confirmModalBody').textContent = args.body;

        // Replace Yes button to clear previous listeners
        var oldBtn = document.getElementById('confirmModalYes');
        var newBtn = oldBtn.cloneNode(true);
        oldBtn.parentNode.replaceChild(newBtn, oldBtn);
        newBtn.addEventListener('click', function () {
            args.success();
            hideModal(modalEl);
        });

        bindDismissButtons(modalEl);
        showModal(modalEl);
    }

    // Alert modal function (vanilla JS)
    function ezal(args) {
        var modalEl = document.getElementById('alertModal');
        document.getElementById('alertModalTitle').textContent = args.title;
        document.getElementById('alertModalBody').textContent = args.body;
        document.getElementById('alertModalButton').textContent = args.button || 'Got it!';

        bindDismissButtons(modalEl);
        showModal(modalEl);
    }
</script>
{% endblock scripts %}
