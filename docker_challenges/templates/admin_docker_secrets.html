{% extends 'admin/base.html' %} {% block content %}
<div class="jumbotron">
    <div class="container">
        <h1>Docker Secrets Management</h1>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            {% for error in errors %}
            <div class="alert alert-danger alert-dismissable" role="alert">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %} {% if docker and not docker.tls_enabled %}
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Warning:</strong> Docker API is not using TLS. Secret transmission is not
                secure.
                <a href="/admin/docker_config" class="alert-link">Configure Docker TLS</a>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="text-center mb-3">
                <button
                    type="button"
                    class="btn btn-success"
                    id="create-secret-btn"
                    {%
                    if
                    not
                    swarm_mode
                    %}disabled{%
                    endif
                    %}
                >
                    <i class="fas fa-plus"></i> Create Secret
                </button>
                {% if secrets %}
                <button type="button" class="btn btn-danger" id="delete-all-secrets-btn">
                    <i class="fas fa-trash"></i> Delete All Secrets
                </button>
                {% endif %}
            </div>

            {% if not swarm_mode %}
            <div class="alert alert-warning text-center" role="alert">
                <i class="fas fa-exclamation-triangle"></i> Docker must be in swarm mode to create
                secrets. Run <code>docker swarm init</code> to enable swarm mode.
            </div>
            {% elif secrets %}
            <!-- Secrets Table -->
            <table id="secrets" class="table table-striped">
                <thead>
                    <tr>
                        <th>Secret Name</th>
                        <th>ID</th>
                        <th>Created</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for secret in secrets %}
                    <tr data-secret-id="{{secret.ID}}">
                        <td>{{secret.Name}}</td>
                        <td>{{secret.ID | truncate(15)}}</td>
                        <td>{{secret.CreatedAt if secret.CreatedAt else 'N/A'}}</td>
                        <td class="text-center">
                            <a
                                class="fas fa-trash delete-secret-btn text-danger"
                                style="cursor: pointer"
                                data-secret-id="{{secret.ID}}"
                                data-secret-name="{{secret.Name}}"
                                title="Delete secret"
                            ></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <h3 class="text-center">No Docker Secrets Created Yet</h3>
            <p class="text-center text-muted">
                Click "Create Secret" above to create your first secret.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Templates (vanilla JS - no Alpine.js dependency) -->
<!-- Create Secret Modal -->
<div class="modal fade" id="createSecretModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Secret</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createSecretForm">
                    <div class="mb-3">
                        <label for="secretName" class="form-label">Secret Name</label>
                        <input
                            type="text"
                            class="form-control"
                            id="secretName"
                            name="name"
                            pattern="[a-zA-Z0-9._-]+"
                            required
                            placeholder="my_secret_name"
                        />
                        <small class="text-muted"
                            >Only letters, numbers, dots, underscores, and hyphens</small
                        >
                    </div>
                    <div class="mb-3">
                        <label for="secretValue" class="form-label">Secret Value</label>
                        <textarea
                            class="form-control"
                            id="secretValue"
                            name="data"
                            rows="4"
                            required
                        ></textarea>
                        <small class="text-muted">Value will be base64-encoded automatically</small>
                    </div>
                    <div
                        id="createSecretError"
                        class="alert alert-danger"
                        style="display: none"
                    ></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-success" id="submitCreateSecret">
                    <i class="fas fa-plus"></i> Create Secret
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalBody"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-danger" id="confirmModalYes">Yes</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="alertModalBody"></p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-dismiss="modal"
                    id="alertModalButton"
                ></button>
            </div>
        </div>
    </div>
</div>
{% endblock content %} {% block scripts %}
<script>
    // Vanilla JS modal helpers (framework-agnostic, works with BS4/BS5 CSS)
    function showModal(modalEl) {
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        modalEl.setAttribute('aria-modal', 'true');
        modalEl.removeAttribute('aria-hidden');
        var backdrop = document.querySelector('.modal-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
        document.body.classList.add('modal-open');
    }

    function hideModal(modalEl) {
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.removeAttribute('aria-modal');
        modalEl.setAttribute('aria-hidden', 'true');
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
        document.body.classList.remove('modal-open');
    }

    function bindDismissButtons(modalEl) {
        modalEl
            .querySelectorAll('[data-bs-dismiss="modal"], [data-dismiss="modal"]')
            .forEach(function (btn) {
                btn.addEventListener('click', function () {
                    hideModal(modalEl);
                });
            });
    }

    // Confirmation modal function (vanilla JS)
    function ezq(args) {
        var modalEl = document.getElementById('confirmModal');
        document.getElementById('confirmModalTitle').textContent = args.title;
        document.getElementById('confirmModalBody').textContent = args.body;

        // Replace Yes button to clear previous listeners
        var oldBtn = document.getElementById('confirmModalYes');
        var newBtn = oldBtn.cloneNode(true);
        oldBtn.parentNode.replaceChild(newBtn, oldBtn);
        newBtn.addEventListener('click', function () {
            args.success();
            hideModal(modalEl);
        });

        bindDismissButtons(modalEl);
        showModal(modalEl);
    }

    // Alert modal function (vanilla JS)
    function ezal(args) {
        var modalEl = document.getElementById('alertModal');
        document.getElementById('alertModalTitle').textContent = args.title;
        document.getElementById('alertModalBody').textContent = args.body;
        document.getElementById('alertModalButton').textContent = args.button || 'Got it!';

        bindDismissButtons(modalEl);
        showModal(modalEl);
    }

    // Create Secret Modal
    document.getElementById('create-secret-btn').addEventListener('click', function () {
        var modalEl = document.getElementById('createSecretModal');
        document.getElementById('createSecretForm').reset();
        document.getElementById('createSecretError').style.display = 'none';
        bindDismissButtons(modalEl);
        showModal(modalEl);
    });

    // Submit Create Secret
    document.getElementById('submitCreateSecret').addEventListener('click', function () {
        const form = document.getElementById('createSecretForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

        fetch('/api/v1/secret', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'CSRF-Token': init.csrfNonce,
            },
            body: JSON.stringify({
                name: formData.get('name'),
                data: formData.get('data'),
            }),
        })
            .then((response) => response.json().then((data) => ({ status: response.status, data })))
            .then((result) => {
                if (result.status === 201 && result.data.success) {
                    hideModal(document.getElementById('createSecretModal'));
                    ezal({ title: 'Success', body: 'Secret created successfully!' });
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    document.getElementById('createSecretError').textContent =
                        result.data.error || 'Failed';
                    document.getElementById('createSecretError').style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-plus"></i> Create Secret';
                }
            })
            .catch(() => {
                document.getElementById('createSecretError').textContent = 'Network error';
                document.getElementById('createSecretError').style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Create Secret';
            });
    });

    // Delete Secret (individual)
    document.querySelectorAll('.delete-secret-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
            const secretId = this.getAttribute('data-secret-id');
            const secretName = this.getAttribute('data-secret-name');
            ezq({
                title: 'Delete Secret?',
                body: `Delete secret '${secretName}'? This cannot be undone.`,
                success: () => deleteSecret(secretId),
            });
        });
    });

    // Delete All Secrets
    const deleteAllBtn = document.getElementById('delete-all-secrets-btn');
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', () => {
            ezq({
                title: 'Delete All Secrets?',
                body: 'Delete ALL secrets? This cannot be undone.',
                success: deleteAllSecrets,
            });
        });
    }

    function deleteSecret(secretId) {
        fetch(`/api/v1/secret/${encodeURIComponent(secretId)}`, {
            method: 'DELETE',
            headers: { 'CSRF-Token': init.csrfNonce },
        })
            .then((response) => response.json().then((data) => ({ status: response.status, data })))
            .then((result) => {
                if (result.data.success) {
                    document.querySelector(`tr[data-secret-id="${secretId}"]`).style.display =
                        'none';
                    ezal({ title: 'Success', body: 'Secret deleted successfully!' });
                } else {
                    ezal({
                        title: result.status === 409 ? 'Cannot Delete' : 'Error',
                        body: result.data.error,
                    });
                }
            })
            .catch(() => ezal({ title: 'Error', body: 'Network error' }));
    }

    function deleteAllSecrets() {
        fetch('/api/v1/secret/all', {
            method: 'DELETE',
            headers: { 'CSRF-Token': init.csrfNonce },
        })
            .then((response) => response.json())
            .then((result) => {
                if (result.success) {
                    ezal({
                        title: 'Complete',
                        body: `Deleted ${result.deleted}. Failed: ${result.failed}.`,
                    });
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    ezal({
                        title: 'Partial Failure',
                        body: `Deleted ${result.deleted}. Failed: ${result.failed}.\n${(result.errors || []).join(', ')}`,
                    });
                    setTimeout(() => window.location.reload(), 1500);
                }
            })
            .catch(() => ezal({ title: 'Error', body: 'Network error' }));
    }
</script>
{% endblock scripts %}
