{% extends 'admin/base.html' %} {% block content %}
<div class="jumbotron">
    <div class="container">
        <h1>Docker Secrets Management</h1>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            {% for error in errors %}
            <div class="alert alert-danger alert-dismissable" role="alert">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %} {% if docker and not docker.tls_enabled %}
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Warning:</strong> Docker API is not using TLS. Secret transmission is not
                secure.
                <a href="/admin/docker_config" class="alert-link">Configure Docker TLS</a>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="text-center mb-3">
                <button
                    type="button"
                    class="btn btn-success"
                    id="create-secret-btn"
                    {%
                    if
                    not
                    swarm_mode
                    %}disabled{%
                    endif
                    %}
                >
                    <i class="fas fa-plus"></i> Create Secret
                </button>
                {% if secrets %}
                <button type="button" class="btn btn-danger" id="delete-all-secrets-btn">
                    <i class="fas fa-trash"></i> Delete All Secrets
                </button>
                {% endif %}
            </div>

            {% if not swarm_mode %}
            <div class="alert alert-warning text-center" role="alert">
                <i class="fas fa-exclamation-triangle"></i> Docker must be in swarm mode to create
                secrets. Run <code>docker swarm init</code> to enable swarm mode.
            </div>
            {% elif secrets %}
            <!-- Secrets Table -->
            <table id="secrets" class="table table-striped">
                <thead>
                    <tr>
                        <th>Secret Name</th>
                        <th>ID</th>
                        <th>Created</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for secret in secrets %}
                    <tr data-secret-id="{{secret.ID}}">
                        <td>{{secret.Name}}</td>
                        <td>{{secret.ID | truncate(15)}}</td>
                        <td>{{secret.CreatedAt if secret.CreatedAt else 'N/A'}}</td>
                        <td class="text-center">
                            <a
                                class="fas fa-trash delete-secret-btn text-danger"
                                style="cursor: pointer"
                                data-secret-id="{{secret.ID}}"
                                data-secret-name="{{secret.Name}}"
                                title="Delete secret"
                            ></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <h3 class="text-center">No Docker Secrets Created Yet</h3>
            <p class="text-center text-muted">
                Click "Create Secret" above to create your first secret.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals (Alpine.js pattern from admin_docker_status.html) -->
<div x-data>
    <!-- Create Secret Modal -->
    <div class="modal fade" x-ref="createSecretModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Secret</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSecretForm">
                        <div class="mb-3">
                            <label for="secretName" class="form-label">Secret Name</label>
                            <input
                                type="text"
                                class="form-control"
                                id="secretName"
                                name="name"
                                pattern="[a-zA-Z0-9._-]+"
                                required
                                placeholder="my_secret_name"
                            />
                            <small class="text-muted"
                                >Only letters, numbers, dots, underscores, and hyphens</small
                            >
                        </div>
                        <div class="mb-3">
                            <label for="secretValue" class="form-label">Secret Value</label>
                            <textarea
                                class="form-control"
                                id="secretValue"
                                name="data"
                                rows="4"
                                required
                            ></textarea>
                            <small class="text-muted"
                                >Value will be base64-encoded automatically</small
                            >
                        </div>
                        <div
                            id="createSecretError"
                            class="alert alert-danger"
                            style="display: none"
                        ></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" id="submitCreateSecret">
                        <i class="fas fa-plus"></i> Create Secret
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" x-ref="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="$store.confirmModal.title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p x-text="$store.confirmModal.body"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        No
                    </button>
                    <button
                        type="button"
                        class="btn btn-danger"
                        @click="$store.confirmModal.onConfirm(); $refs.confirmModal.dispatchEvent(new Event('hide.bs.modal'))"
                    >
                        Yes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal fade" x-ref="alertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="$store.alertModal.title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p x-text="$store.alertModal.body"></p>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-primary"
                        data-bs-dismiss="modal"
                        x-text="$store.alertModal.button"
                    ></button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %} {% block scripts %}
<script>
    // Initialize Alpine.js stores
    if (typeof Alpine !== 'undefined') {
        Alpine.store('confirmModal', { title: '', body: '', onConfirm: () => {} });
        Alpine.store('alertModal', { title: '', body: '', button: 'Got it!' });
    }

    // Helper: Show confirmation modal
    function ezq(args) {
        if (typeof Alpine === 'undefined' || typeof bootstrap === 'undefined') {
            if (confirm(args.title + '\n\n' + args.body)) args.success();
            return;
        }
        Alpine.store('confirmModal', {
            title: args.title,
            body: args.body,
            onConfirm: args.success,
        });
        new bootstrap.Modal(document.querySelector('[x-ref="confirmModal"]')).show();
    }

    // Helper: Show alert modal
    function ezal(args) {
        if (typeof Alpine === 'undefined' || typeof bootstrap === 'undefined') {
            alert(args.title + '\n\n' + args.body);
            return;
        }
        Alpine.store('alertModal', {
            title: args.title,
            body: args.body,
            button: args.button || 'Got it!',
        });
        new bootstrap.Modal(document.querySelector('[x-ref="alertModal"]')).show();
    }

    // Create Secret Modal
    document.getElementById('create-secret-btn').addEventListener('click', function () {
        const modal = new bootstrap.Modal(document.querySelector('[x-ref="createSecretModal"]'));
        document.getElementById('createSecretForm').reset();
        document.getElementById('createSecretError').style.display = 'none';
        modal.show();
    });

    // Submit Create Secret
    document.getElementById('submitCreateSecret').addEventListener('click', function () {
        const form = document.getElementById('createSecretForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

        fetch('/api/v1/secret', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'CSRF-Token': init.csrfNonce,
            },
            body: JSON.stringify({
                name: formData.get('name'),
                data: formData.get('data'),
            }),
        })
            .then((response) => response.json().then((data) => ({ status: response.status, data })))
            .then((result) => {
                if (result.status === 201 && result.data.success) {
                    bootstrap.Modal.getInstance(
                        document.querySelector('[x-ref="createSecretModal"]')
                    ).hide();
                    ezal({ title: 'Success', body: 'Secret created successfully!' });
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    document.getElementById('createSecretError').textContent =
                        result.data.error || 'Failed';
                    document.getElementById('createSecretError').style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-plus"></i> Create Secret';
                }
            })
            .catch(() => {
                document.getElementById('createSecretError').textContent = 'Network error';
                document.getElementById('createSecretError').style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Create Secret';
            });
    });

    // Delete Secret (individual)
    document.querySelectorAll('.delete-secret-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
            const secretId = this.getAttribute('data-secret-id');
            const secretName = this.getAttribute('data-secret-name');
            ezq({
                title: 'Delete Secret?',
                body: `Delete secret '${secretName}'? This cannot be undone.`,
                success: () => deleteSecret(secretId),
            });
        });
    });

    // Delete All Secrets
    const deleteAllBtn = document.getElementById('delete-all-secrets-btn');
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', () => {
            ezq({
                title: 'Delete All Secrets?',
                body: 'Delete ALL secrets? This cannot be undone.',
                success: deleteAllSecrets,
            });
        });
    }

    function deleteSecret(secretId) {
        fetch(`/api/v1/secret/${secretId}`, {
            method: 'DELETE',
            headers: { 'CSRF-Token': init.csrfNonce },
        })
            .then((response) => response.json().then((data) => ({ status: response.status, data })))
            .then((result) => {
                if (result.data.success) {
                    document.querySelector(`tr[data-secret-id="${secretId}"]`).style.display =
                        'none';
                    ezal({ title: 'Success', body: 'Secret deleted successfully!' });
                } else {
                    ezal({
                        title: result.status === 409 ? 'Cannot Delete' : 'Error',
                        body: result.data.error,
                    });
                }
            })
            .catch(() => ezal({ title: 'Error', body: 'Network error' }));
    }

    function deleteAllSecrets() {
        fetch('/api/v1/secret/all', {
            method: 'DELETE',
            headers: { 'CSRF-Token': init.csrfNonce },
        })
            .then((response) => response.json())
            .then((result) => {
                if (result.success) {
                    ezal({
                        title: 'Complete',
                        body: `Deleted ${result.deleted}. Failed: ${result.failed}.`,
                    });
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    ezal({ title: 'Error', body: result.error });
                }
            })
            .catch(() => ezal({ title: 'Error', body: 'Network error' }));
    }
</script>
{% endblock scripts %}
